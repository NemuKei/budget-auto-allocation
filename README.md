
# 日別予算自動割当ツール

## 概要

このツールは、ホテルや宿泊施設向けに**月次予算から日別予算を自動で割り当てる**Python製アプリケーションです。以下のロジックで、曜日別傾向・祝日・連休・稼働率・売上構成などを考慮した現実的な日別予算を算出します。

---

## 主な機能

- 月次予算 (`input/` フォルダのCSV) をベースに、日別宿泊売上・室数・人数・喫食数・各種売上項目を割当
- 曜日別の稼働傾向（前年同月、直近1ヶ月、直近2〜3ヶ月）を基に平滑化係数を算出
- 祝前日・連休などに対してボリューム配分の調整
- 宿泊売上・室数・人数は実績データに基づく上限・下限を考慮し、異常値を排除
- 合計値が月次予算と正確に一致するよう最終調整
- ADR（客室単価）、OCC（稼働率）、RevPAR、DOR（1室あたり人数）などの指標を日次で自動計算
- GUIからパラメータ（ウェイト、価格、キャパシティなど）の変更が可能

---

## ファイル構成

```
budget-auto-allocation/
├── main.py               ... メイン処理スクリプト（Tkinter GUI + ロジック）
├── README.md             ... 本ファイル
├── input/
│   ├── 月次予算.csv       ... 年・月ごとの予算（宿泊売上、室数、朝食など）
│   ├── 日別実績.csv       ... 過去日次実績（日付・宿泊売上・室数・人数など）
├── output/
│   └── 日別予算_2025.xlsx ... 出力結果（シート毎に月別データ）
```

---

## GUI画面の設定項目

| ラベル | 説明 |
|-------|------|
| 年度 | 対象会計年度（例：2025） |
| 室数キャパシティ | 最大部屋数（稼働率算出用） |
| 朝食単価 | 1名あたり朝食価格（円） |
| 前年同月ウェイト | 平滑化係数における前年データの重み（例：0.7） |
| 2-3ヶ月前ウェイト | 同上、中期データの重み（例：0.1） |
| 直近1ヶ月ウェイト | 同上、最新データの重み（例：0.2） |

※ ウェイトの合計は 1.0 になるように調整してください。

---

## 計算ロジックの流れ

1. **平滑化係数の作成**
   - 室数、人数、宿泊売上の曜日別構成比を、以下の期間ごとに集計
     - 前年同月（存在しなければ前々年同月）
     - 日別実績内の最新日付を基点とした直近1ヶ月
     - 同じく直近2〜3ヶ月
   - 上記3期間から算出した構成比を、指定ウェイトで平滑化

2. **初期配分**
   - 月次平均値（宿泊売上・室数・人数） × 平滑化係数 で日別に初期配分

3. **祝日・祝前日・連休の補正**
   - 土曜の構成比をベースに、連休初日は+10%、中日は-10%補正
   - 飛び石祝日は特別扱いせず、通常曜日として処理

4. **実績ベースの上限・下限補正**
   - 室数・人数・宿泊売上には過去実績をベースとした上限値／下限値を設定
   - これを超えないようにクリップし、配分を調整

5. **合計値の調整**
   - 全項目で、月次合計値と一致するよう微調整
   - 調整後にRevPARやOCC、ADRを再計算

6. **Excel出力**
   - `output/日別予算_202X.xlsx` に月別シートで出力
   - 各行には曜日・祝日・各種指標（ADR/OCC/DOR/RevPAR）を含む
---

## 祝日・連休処理の改善（2025/06/10 更新）

従来のロジックでは、曜日別の構成比で一旦全日を配分した後、祝前日や連休に対して事後的に調整を加えていたため、以下のような問題がありました：

- 連休中すべての日に等しい売上が割り振られる（例：3連休がすべて同額）
- 元日など特日が過剰・過小に評価される
- 月次予算と日別合計の整合性が崩れるケースがある

### 🔧 改善内容

- **平滑化係数（ratios）の段階で祝日・連休・特日を一体的に考慮**し、曜日と特日を同列のキーとしてratiosを作成
- `day_key()` 関数を拡張し、祝前日・年末年始などを独立キーに分類（例：('Sat', 'NYE')、('Sun', 'NYD') など）
- `weekday_dist()` 関数内で各keyごとに過去実績から比率を構成
- `apply_distribution()` では純粋にこのratiosに基づいて初期配分を行うため、事後補正は不要に
- 元日や三が日などの**特別日ブロック**については個別係数で補完（例：元日 = 土曜の0.9倍）

### 🎯 効果

- 日別配分における祝日・特日の過剰補正を抑制
- 宿泊売上・室数・人数などの月次合計が正確に一致
- 特定日の売上が高すぎる・低すぎる問題を回避

---

## 実行方法

```bash
# 必要ライブラリをインストール
pip install pandas openpyxl jpholiday

# スクリプトを実行
python main.py
```

GUIが立ち上がるので、パラメータを入力後「実行」をクリックしてください。

---

## ライセンス

MIT License

---

## 今後の改善候補

- 平滑化係数における曜日構成比を月単位で動的に学習
- 実績乖離アラートの導入（例：DORが過去乖離±20%なら警告）
- AIによる価格最適化（ADR自動提案）

